[build]
  functions = "netlify/functions"
  publish = "static"
  # Copy app files AND install dependencies to function directory
  command = """
    echo 'Starting Netlify build...' && \
    python -m pip install -U pip && \
    python -m pip install -r requirements.txt -t netlify/functions && \
    cp app.py netlify/functions/ && \
    cp -r templates netlify/functions/ 2>/dev/null || true && \
    cp -r static netlify/functions/ 2>/dev/null || true && \
    cp *.woff netlify/functions/ 2>/dev/null || true && \
    echo 'Build complete. Function contents:' && \
    ls -la netlify/functions/
  """

  [build.environment]
    PYTHON_VERSION = "3.11"

[functions]
  # Explicitly set Python runtime
  node_bundler = "esbuild"
  included_files = [
    "**/*.py",
    "**/*.html",
    "**/*.css",
    "**/*.js",
    "**/*.woff",
    "**/*.woff2",
    "**/*.json"
  ]

# Static files bypass function
[[redirects]]
  from = "/static/*"
  to = "/static/:splat"
  status = 200
  force = true

# Root path explicitly to function
[[redirects]]
  from = "/"
  to = "/.netlify/functions/server"
  status = 200
  force = true

# All other paths to function
[[redirects]]
  from = "/*"
  to = "/.netlify/functions/server/:splat"
  status = 200
