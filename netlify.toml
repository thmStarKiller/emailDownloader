[build]
  functions = "netlify/functions"
  publish = "static"
  # Explicitly activate mise-managed Python, then install dependencies
  command = "mise install || true; eval \"$(mise activate bash)\"; python -V; python -m pip install --upgrade pip; python -m pip install -r requirements.txt"

  [build.environment]
    PIP_NO_CACHE_DIR = "off"

[functions]
  included_files = [
    "app.py",
    "templates/**",
    "static/**",
    "Comodo-Regular.woff"
  ]

# Serve static assets directly first (keeps them on CDN instead of invoking the function)
[[redirects]]
  from = "/static/*"
  to = "/static/:splat"
  status = 200
  force = true

# Explicit API endpoints (preserve path using :splat where needed)
[[redirects]]
  from = "/start_download"
  to = "/.netlify/functions/server/start_download"
  status = 200

[[redirects]]
  from = "/download"
  to = "/.netlify/functions/server/download"
  status = 200

[[redirects]]
  from = "/progress/*"
  to = "/.netlify/functions/server/progress/:splat"
  status = 200

[[redirects]]
  from = "/complete"
  to = "/.netlify/functions/server/complete"
  status = 200

[[redirects]]
  from = "/download_result/*"
  to = "/.netlify/functions/server/download_result/:splat"
  status = 200

# Catchâ€‘all (root + any other Flask route). Must be last.
[[redirects]]
  from = "/*"
  to = "/.netlify/functions/server/:splat"
  status = 200
